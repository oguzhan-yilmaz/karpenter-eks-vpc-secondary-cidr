apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: default
spec:
  # required, resolves a default ami and userdata
  amiFamily: AL2                
  
  # required, discovers subnets to attach to instances
  subnetSelectorTerms:          
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
  
  # required, discovers security groups to attach to instances
  securityGroupSelectorTerms:   
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
        
  # required, IAM role to use for the node identity
  role: "KarpenterNodeRole-${CLUSTER_NAME}"

  # optional, discovers amis to override the amiFamily's default
  amiSelectorTerms:             
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
  # optional, overrides autogenerated userdata with a merge semantic
  userData: |
    #!/bin/bash
    echo "Userdata script: $(date)"
    echo "Installing SSM Agent"
    sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
    sudo systemctl status amazon-ssm-agent             
  # optional, propagates tags to underlying EC2 resources
  tags:                  
    team: team-a
    app: team-a-app
  # optional, configures storage devices for the instance
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 60Gi
        volumeType: gp3
  # optional, configures detailed monitoring for the instance
  # detailedMonitoring: true